<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Chaos Feild</title>
    <link rel="stylesheet" href="style.css"> 
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  </head>
  <body>
    <img id='test' width='128' height='128' src='https://raw.githubusercontent.com/Komponent1/chaosfield/master/app/coeruco.png' crossorigin="anonymous"/>
    <button id='start' disabled='disabled'>Start</button>
    <button id='stop' disabled='disabled'>Stop</button>
    <canvas id="canvas2"></canvas>
    <video id='video' autoplay ></video>
  </body>
  <script type='text/javascript'>
    const screen = document.getElementById('video');
    const start = document.getElementById('start');
    const stop = document.getElementById('stop');
    const img = document.getElementById('test');
    
    let target = null;
    let model = null;
    let id = null;

    async function setModel() {
      model = await tf.loadGraphModel("https://tfhub.dev/google/tfjs-model/imagenet/mobilenet_v2_075_128/feature_vector/2/default/1", { fromTFHub: true })
      target = getFeature(img);

      start.disabled = false;
      stop.disabled = false;
    };
    setModel();
    function getFeature(input) {
      let tfimg = tf.cast(tf.browser.fromPixels(input), 'float32');
      tfimg = tfimg.reshape([1, ...tfimg.shape]); 
      const featrue = model.execute(tfimg);

      return featrue;
    }
    function getSimilarty(input) {
      const dot = tf.dot(target, tf.transpose(input));
      const a = tf.sqrt(tf.dot(target, tf.transpose(target)));
      const b = tf.sqrt(tf.dot(input, tf.transpose(input)));
      const sim = dot.div(a.mul(b));

      return sim.dataSync();
    }
    
    function getImgFromVideo(position) {
      const canvas1 = document.createElement('canvas');
      const ctx1 = canvas1.getContext('2d');
      canvas1.width = screen.videoWidth;
      canvas1.height = screen.videoHeight;
      ctx1.drawImage(screen, 0, 0, screen.videoWidth, screen.videoHeight);

      const capture = ctx1.getImageData(...position);
      const canvas2 = document.getElementById('canvas2');
      const ctx2 = canvas2.getContext('2d');
      canvas2.width = screen.videoWidth;
      canvas2.height = screen.videoHeight;
      ctx2.putImageData(capture, 0, 0);

      return capture;
    }

    function check() {
      const feature = getFeature(getImgFromVideo([958, 234, 128, 128]));
      const sim = getSimilarty(feature);

      console.log(sim);
    }
    async function startCapture() {
      let captureStream = null;

      const option = {
        audio: false,
        displaySurface: 'application',
        video: { 
          cursor: 'always',
        }
      };

      try {
        captureStream = await navigator.mediaDevices.getDisplayMedia(option);
        screen.srcObject = captureStream;

        id = setInterval(check, 1000);
      } catch (err) {
        console.log(err);
      }

      return captureStream;
    }
    function stopCapture() {
      const tracks = screen.srcObject.getTracks();
      tracks.forEach(track => track.stop());
      screen.srcObject = null;

      clearInterval(id);
    }
    start.addEventListener('click', startCapture);
    stop.addEventListener('click', stopCapture);

  </script>
</html>